# MeshKit 版本发行指南

## 概述

本文档详细说明 MeshKit 项目的版本发行流程，包括桌面应用打包、GitHub Release 发布、版本号管理等完整步骤。MeshKit 主要有两种发行形式：桌面应用的安装包和 Web 应用的静态部署文件。

## 版本发行准备

### 确定版本号

MeshKit 采用语义化版本号（Semantic Versioning）规范，版本号格式为 `主版本号.次版本号.修订号`（如 1.0.0）。在发布新版本前，需要根据变更内容确定版本号的递增规则。

**主版本号递增**：当进行了不兼容的 API 修改时。例如，核心架构重构，导致与旧版本数据不兼容，或者移除了某些重要功能。这种情况比较少见，通常在项目有重大变革时才会递增主版本号。

**次版本号递增**：当添加了新功能，但保持向后兼容时。例如，新增了视频通话功能，或者改进了文件传输的性能，但不影响现有功能的使用。大部分功能更新都属于这个类别。

**修订号递增**：当进行了向后兼容的问题修复时。例如，修复了加密聊天的一个 bug，或者优化了界面显示问题。日常的 bug 修复都应该递增修订号。

确定好版本号后，需要更新项目中的版本信息。主要需要修改以下文件：

- `package.json`：根目录的项目版本号
- `packages/desktop/package.json`：桌面应用版本号
- `packages/web/package.json`：Web 应用版本号
- `packages/core/package.json`：核心包版本号

确保所有包的版本号保持一致，避免版本混乱。可以使用文本编辑器批量查找替换，或者使用版本管理工具。

### 更新变更日志

每次发布新版本都应该更新 CHANGELOG.md 文件，记录本次版本的所有变更。如果项目中还没有这个文件，需要先创建。变更日志应该包含以下内容：

**版本号和发布日期**：清楚标注本次版本的版本号和发布日期，例如 `## [1.1.0] - 2024-01-20`。

**变更分类**：将变更按类型分类，常见的分类包括：
- Added（新增）：新增的功能特性
- Changed（变更）：对现有功能的修改
- Deprecated（弃用）：即将移除的功能
- Removed（移除）：已经移除的功能
- Fixed（修复）：bug 修复
- Security（安全）：安全相关的修复

每个分类下列出具体的变更内容，使用简洁明了的语言描述。例如：

```markdown
## [1.1.0] - 2024-01-20

### Added
- 新增断点续传功能，支持大文件传输中断后继续传输
- 添加暗色主题支持，可在设置中切换

### Fixed
- 修复便签墙在某些情况下无法同步的问题
- 修复加密聊天连接断开后无法重连的 bug

### Changed
- 优化文件传输速度，提升 20% 性能
- 改进用户界面，提升视觉体验
```

### 测试验证

在正式发布前，必须进行充分的测试，确保新版本的稳定性。测试应该覆盖以下方面：

**功能测试**：测试所有核心功能是否正常工作。包括文件传输、便签墙同步、加密聊天等。特别要测试本次版本新增或修改的功能，确保它们按预期工作。

**跨平台测试**：在不同操作系统上测试桌面应用，包括 Windows、macOS 和 Linux。确保在各个平台上都能正常安装、启动和使用。Web 应用需要在主流浏览器上测试，包括 Chrome、Firefox、Safari 和 Edge。

**兼容性测试**：如果有老版本用户，测试新版本与老版本之间的兼容性。例如，新版本的客户端能否与老版本的客户端正常通信，数据格式是否兼容等。

**性能测试**：测试系统在各种负载下的性能表现。例如，传输大文件时的速度和稳定性，多人同时编辑便签墙时的响应速度等。

**回归测试**：确保修复的 bug 不会再次出现，新增的功能不会影响已有功能的正常工作。可以准备一个测试清单，每次发布前都按清单逐项测试。

## 桌面应用发布

### 构建桌面应用

桌面应用是 MeshKit 的重要发行形式。构建过程会将应用打包成各个平台的安装包，用户下载后即可安装使用。

**准备构建环境**：首先确保已经安装了所有必要的依赖。在项目根目录执行 `pnpm install` 确保所有依赖都已安装。然后构建核心包，执行 `pnpm --filter @meshkit/core build`。这一步很重要，因为桌面应用依赖核心包。

**进入桌面应用目录**：使用 `cd packages/desktop` 命令进入桌面应用的目录。后续的构建命令都在这个目录下执行。

**构建全平台安装包**：执行 `pnpm release` 命令会构建当前操作系统平台的安装包。这个命令会先执行 `pnpm build` 构建应用代码，然后调用 electron-builder 打包。构建过程可能需要几分钟，取决于电脑性能。

如果需要为特定平台构建，可以使用以下命令：
- `pnpm release:win`：构建 Windows 安装包（NSIS 安装程序和 Portable 便携版）
- `pnpm release:mac`：构建 macOS 安装包（DMG 磁盘映像和 ZIP 压缩包）
- `pnpm release:linux`：构建 Linux 安装包（AppImage、deb 和 rpm）

**跨平台构建限制**：需要注意的是，某些平台的构建只能在对应系统上进行。例如，macOS 的 DMG 格式只能在 macOS 系统上构建，因为需要 macOS 的代码签名工具。Windows 的安装包可以在其他平台构建，但建议在 Windows 上构建以获得最佳兼容性。

**查看构建产物**：构建完成后，安装包文件会保存在 `packages/desktop/release` 目录下。文件名格式为 `MeshKit-版本号-平台-架构.扩展名`，例如 `MeshKit-1.0.0-win-x64.exe`。检查文件是否生成成功，文件大小是否正常（通常在 100-200MB 之间）。

### macOS 代码签名（可选）

如果要正式发布 macOS 应用，建议进行代码签名。未签名的应用在 macOS 上会显示"来自未识别的开发者"警告，影响用户体验。

**申请开发者证书**：需要加入 Apple Developer Program（需付费），在开发者账号中创建开发者 ID 证书。下载证书并安装到 Keychain Access 中。

**配置签名**：在 `packages/desktop/package.json` 的 build 配置中，mac 部分已经包含了签名相关配置。需要设置环境变量指定证书：

```bash
export CSC_NAME="Developer ID Application: Your Name (Team ID)"
pnpm release:mac
```

**公证应用**：macOS 10.15 之后，除了签名还需要公证。配置 Apple ID 和专用密码：

```bash
export APPLE_ID="your-apple-id@example.com"
export APPLE_ID_PASSWORD="xxxx-xxxx-xxxx-xxxx"  # 专用密码
pnpm release:mac
```

electron-builder 会自动处理公证流程，但需要等待 Apple 服务器处理，可能需要几分钟到半小时。

### Windows 代码签名（可选）

Windows 应用的代码签名可以避免 SmartScreen 警告，提高用户信任度。

**获取代码签名证书**：可以从 DigiCert、Sectigo 等证书颁发机构购买代码签名证书。获得证书文件（通常是 .pfx 或 .p12 格式）和密码。

**配置签名**：设置环境变量并构建：

```bash
export CSC_LINK=/path/to/certificate.pfx
export CSC_KEY_PASSWORD=your_password
pnpm release:win
```

electron-builder 会在构建过程中自动对可执行文件进行签名。

### 测试安装包

构建完成后，必须在目标平台上测试安装包，确保能正常安装和运行。

**Windows 测试**：在 Windows 系统上双击 `.exe` 文件，按照安装向导完成安装。测试安装后的应用能否正常启动，所有功能是否正常工作。测试完成后卸载，检查是否有残留文件。

**macOS 测试**：在 macOS 上双击 `.dmg` 文件，将应用拖动到应用程序文件夹。启动应用，测试各项功能。检查系统偏好设置中的权限请求（如网络访问）是否正常。

**Linux 测试**：AppImage 格式最为方便，下载后赋予执行权限（`chmod +x MeshKit-*.AppImage`）即可运行。deb 包用于 Debian/Ubuntu 系统（`sudo dpkg -i MeshKit-*.deb`），rpm 包用于 Fedora/CentOS 系统（`sudo rpm -i MeshKit-*.rpm`）。

## GitHub Release 发布

### 创建 Git 标签

在发布前，需要为本次版本打一个 Git 标签，标记这个版本的代码快照。

**提交所有变更**：确保所有代码变更都已提交到 Git。运行 `git status` 检查是否有未提交的文件。如果有，使用 `git add` 和 `git commit` 提交它们。

**创建标签**：使用带注释的标签（annotated tag），包含版本信息和简要说明：

```bash
git tag -a v1.0.0 -m "Release version 1.0.0"
```

标签名称建议使用 `v` 前缀加版本号的格式，这是业界通用的约定。

**推送标签到远程**：本地创建的标签默认不会推送到远程仓库，需要显式推送：

```bash
git push origin v1.0.0
```

如果有多个标签需要推送，可以使用 `git push origin --tags` 一次性推送所有标签。

### 在 GitHub 创建 Release

访问项目的 GitHub 页面，点击右侧的 "Releases" 链接，然后点击 "Draft a new release" 按钮开始创建新版本发布。

**选择标签**：在 "Choose a tag" 下拉框中选择刚才创建的标签（如 v1.0.0）。如果忘记推送标签，也可以在这里直接输入新标签名，GitHub 会在发布时自动创建。

**填写发布信息**：
- **Release title**：版本标题，通常使用 `v1.0.0` 或 `MeshKit v1.0.0` 这样的格式
- **描述内容**：复制 CHANGELOG.md 中本次版本的变更内容，或者用 Markdown 格式重新编写。应该包括新功能说明、bug 修复列表、重要变更提醒等。可以添加截图展示新功能

**上传安装包**：在页面底部的 "Attach binaries" 区域，上传之前构建的安装包文件。可以拖拽文件或点击选择文件。建议上传所有平台的安装包，方便不同系统的用户下载。

需要上传的文件包括：
- Windows：`.exe` NSIS 安装程序
- macOS：`.dmg` 磁盘映像
- Linux：`.AppImage` 通用格式，以及 `.deb` 和 `.rpm` 包

**设置版本类型**：如果这是一个预发布版本（如 beta、rc 版本），勾选 "This is a pre-release" 选项。正式版本不要勾选这个选项。

**发布**：检查所有信息无误后，点击 "Publish release" 按钮正式发布。发布后，用户就可以在 GitHub 的 Releases 页面看到新版本并下载安装包。

### 编写发布说明

好的发布说明能帮助用户快速了解新版本的价值。发布说明应该包含以下内容：

**版本亮点**：用一两句话概括本次版本的最重要改进，吸引用户关注。例如："本次更新大幅提升了文件传输速度，并新增了暗色主题支持。"

**新功能介绍**：列出所有新增功能，配以简短说明。如果功能较复杂，可以添加使用说明或链接到详细文档。

**改进说明**：列出性能优化、界面改进等内容。量化的数据更有说服力，例如"传输速度提升 30%"而不是"传输更快了"。

**Bug 修复**：列出重要的 bug 修复，特别是影响用户体验的问题。可以附上 issue 编号方便追溯。

**已知问题**：如果有已知但未修复的问题，诚实地告知用户，并说明计划何时修复或提供临时解决方案。

**升级说明**：如果从老版本升级需要特殊操作（如数据迁移、配置修改），一定要明确说明步骤。

**下载链接**：虽然 GitHub Release 页面已经有下载链接，但在说明中也可以明确列出各平台的下载文件名，方便用户找到对应版本。

## Web 应用发布

### 构建生产版本

Web 应用的发布主要是构建静态文件并部署到服务器。

**构建 Web 应用**：在项目根目录执行 `pnpm build:web` 命令。这会调用 Vite 对 Web 应用进行生产构建，包括代码压缩、资源优化、哈希文件名等处理。

构建过程会输出一些统计信息，包括文件大小、gzip 压缩后大小等。注意检查是否有警告信息，如果文件过大可能需要优化。

**查看构建产物**：构建完成后，静态文件生成在 `packages/web/dist` 目录。这个目录包含了 `index.html`、JavaScript 文件、CSS 文件和其他资源文件。整个目录的内容就是需要部署的 Web 应用。

**本地测试**：在部署前，可以在本地测试构建产物。使用简单的 HTTP 服务器（如 `npx serve dist`）或配置 Nginx，访问查看是否正常工作。特别要测试路由是否正确，刷新页面是否会 404。

### 部署到服务器

根据使用的托管方式不同，部署步骤有所区别。

**Nginx 部署**：这是最常见的部署方式。将 `dist` 目录的内容复制到服务器的 Web 根目录（如 `/var/www/meshkit`）。配置 Nginx：

```nginx
server {
    listen 80;
    server_name meshkit.example.com;
    root /var/www/meshkit;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

重点是 `try_files` 配置，这样可以支持 React Router 的客户端路由，刷新页面不会 404。

**Vercel/Netlify 部署**：这些平台提供了自动化部署。连接 GitHub 仓库后，每次推送代码都会自动构建和部署。在平台上配置构建命令为 `pnpm build:web`，输出目录为 `packages/web/dist`。

**Docker 部署**：项目已经提供了 Dockerfile，可以构建 Docker 镜像并部署：

```bash
docker build -t meshkit-web -f packages/web/Dockerfile .
docker run -d -p 80:80 meshkit-web
```

容器内使用 Nginx 提供静态文件服务，配置已经包含在镜像中。

### 配置 HTTPS（可选）

如需在生产环境部署或配置 HTTPS，请自行配置。本项目主要面向本地和局域网使用场景。

## 版本更新机制

### 自动更新（桌面应用）

桌面应用已经集成了 `electron-updater`，支持自动检查更新。要启用自动更新，需要配置更新服务器。

**配置更新服务器**：在 GitHub Release 发布新版本后，electron-updater 可以自动从 GitHub 获取更新信息。在 `packages/desktop/package.json` 的 build 配置中添加：

```json
{
  "build": {
    "publish": {
      "provider": "github",
      "owner": "your-username",
      "repo": "meshkit"
    }
  }
}
```

**实现更新逻辑**：在主进程代码中添加更新检查：

```javascript
import { autoUpdater } from 'electron-updater';

autoUpdater.checkForUpdatesAndNotify();

autoUpdater.on('update-available', () => {
  // 通知用户有新版本
});

autoUpdater.on('update-downloaded', () => {
  // 提示用户重启应用安装更新
});
```

应用启动时会自动检查更新，发现新版本后会在后台下载，下载完成后提示用户重启安装。

**用户手动检查**：也可以在应用菜单中添加"检查更新"选项，让用户手动触发更新检查。

## 发布后工作

### 公告通知

新版本发布后，应该通过各种渠道通知用户。

**GitHub 通知**：GitHub Release 本身会生成通知，关注项目的用户会收到。在项目 README 中也可以添加最新版本的信息和下载链接。

**社区公告**：如果项目有讨论区、论坛或社交媒体账号，发布公告说明新版本的改进。可以撰写更详细的发布博客，介绍新功能的使用方法和设计思路。

**文档更新**：确保文档与新版本同步。如果有新功能，需要更新使用文档；如果有配置变更，需要更新部署文档。

### 收集反馈

发布后密切关注用户反馈，及时发现和修复问题。

**监控 Issues**：关注 GitHub Issues，用户可能会报告 bug 或提出建议。对于 bug 报告要及时响应，请用户提供详细信息以便复现问题。

**收集使用数据**：如果应用有错误日志上报功能，分析日志找出常见问题。注意保护用户隐私，只收集必要的错误信息，不要收集敏感数据。

**用户调查**：可以通过问卷等方式收集用户对新版本的意见，了解哪些功能受欢迎，哪些需要改进。

### 补丁版本

如果发现严重 bug，需要尽快发布补丁版本。补丁版本的流程相对简单：

1. 修复 bug 并测试
2. 递增修订号（如 1.0.0 → 1.0.1）
3. 更新 CHANGELOG
4. 构建并发布（流程同上）
5. 在 Release 说明中明确标注这是 bug 修复版本

对于严重影响使用的 bug，应该在 24 小时内发布补丁；对于一般问题，可以累积几个 bug 一起修复后发布。

## 最佳实践建议

### 发布节奏

建立规律的发布节奏有助于用户了解项目的活跃程度。对于 MeshKit 这样的项目，建议采用以下节奏：

**主要版本更新**：每半年到一年一次，包含重大功能或架构改进。提前公布路线图，让用户了解开发方向。

**次要版本更新**：每 1-2 个月一次，包含新功能和较大的改进。功能开发完成并充分测试后即可发布。

**补丁版本更新**：根据需要随时发布，主要修复 bug。严重 bug 应该立即修复发布，一般问题可以积累几个一起发布。

**预发布版本**：对于重大更新，可以先发布 beta 或 rc 版本，邀请用户测试，收集反馈后再发布正式版本。

### 版本兼容性

在开发新功能时，始终考虑兼容性问题。尽量保持向后兼容，让用户可以平滑升级。如果必须引入不兼容变更，应该：

**提前通知**：在前一个版本中标记将要废弃的功能，给用户时间迁移。例如，在 1.0 版本中标记某 API 为 deprecated，在 2.0 版本中才真正移除。

**提供迁移指南**：编写详细的升级文档，说明如何从旧版本迁移到新版本。如果数据格式有变化，提供数据迁移工具或脚本。

**保持协议兼容**：客户端之间的通讯协议要特别注意兼容性。如果可能，让新版本客户端能够与老版本客户端通信，至少在一段过渡期内如此。

### 质量保证

每次发布前都要进行充分测试，避免将明显 bug 带入正式版本。建立测试清单，包含所有核心功能的测试项。考虑引入自动化测试，减少人工测试的工作量和疏漏。

对于桌面应用，在虚拟机中测试可以确保在干净系统上也能正常工作。对于 Web 应用，使用不同浏览器和设备测试，确保兼容性。

收集用户的崩溃报告和错误日志，找出最常见的问题并优先修复。建立质量指标，如崩溃率、错误率等，持续改进产品质量。

## 总结

版本发行是软件开发的重要环节，需要谨慎对待。通过规范的流程、充分的测试和及时的反馈处理，可以确保每次发布都能为用户带来价值，同时保持产品的稳定性和质量。

建议准备一个发布清单，每次发布前都按清单逐项检查，避免遗漏重要步骤。随着项目的发展，发布流程可能需要不断优化和完善，但核心原则保持不变：代码质量第一，用户体验至上。
